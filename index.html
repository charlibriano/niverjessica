<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carta para Jéssica 💌</title>
<meta name="theme-color" content="#22c55e">
<style>
  :root{
    --bg:#0f1115; --card:#141821; --paper:#fffdf8; --line:#e9eef6;
    --accent:#22c55e; --ink:#2b2b2b; --text:#f7f7fb; --glass:rgba(255,255,255,.06);
    --wrap:900px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1400px 900px at -20% -10%, #20172a 0, transparent 60%),
      radial-gradient(1200px 700px at 120% 0%, #112230 0, transparent 55%),
      var(--bg);
    min-height:100svh;display:flex;align-items:center;justify-content:center;padding:12px;
    overflow-x:hidden;
    background-attachment: fixed;
    --glowX:50%; --glowY:40%; --glowC:rgba(34,197,94,.18);
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
    background: radial-gradient(500px 320px at var(--glowX) var(--glowY), var(--glowC), transparent 70%);
    filter: blur(28px);
  }
  .wrap{width:min(var(--wrap),100%); animation:fadeUp .6s ease-out both}
  @keyframes fadeUp{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}

  /* CAPA (envelope) */
  .capa{
    position:relative;background:linear-gradient(180deg,#63e2a8,#22c55e);
    border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.35);
    padding:18px;display:grid;place-items:center;aspect-ratio:16/9;overflow:hidden;
  }
  .capa.hide{ display:none !important; }
  .flap{
    position:absolute;left:0;right:0;top:0;height:50%;
    background:linear-gradient(180deg,#c9f6df,#7ee0af);
    clip-path:polygon(0 0,100% 0,50% 100%);
    transform-origin:50% 0;transition:transform .9s cubic-bezier(.22,1,.36,1);
    box-shadow:0 10px 26px rgba(0,0,0,.35);
  }
  .selo{position:absolute;left:50%;top:48%;transform:translate(-50%,-50%);
    background:#e7ffe7;color:#096d36;border-radius:999px;padding:8px 14px;font-weight:800;letter-spacing:.04em;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .cta-heart{width:130px;height:118px;background:transparent;border:none;cursor:pointer;padding:0;
    display:block;filter:drop-shadow(0 10px 20px rgba(0,0,0,.25));animation:pulse 1.8s ease-in-out infinite}
  .cta-heart svg{width:100%;height:100%;display:block}
  .cta-heart .label{position:absolute;inset:0;display:grid;place-items:center;text-align:center;color:#fff;font-weight:900;font-size:1.02rem;line-height:1.05}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  .beat{animation:beat .95s ease-in-out infinite !important}
  @keyframes beat{0%{transform:scale(1)}20%{transform:scale(1.08)}40%{transform:scale(1)}60%{transform:scale(1.05)}100%{transform:scale(1)}}

  .fallback-open{position:fixed;left:10px;bottom:10px;z-index:50;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.3)}

  /* CARTA (mobile-first, altura fixa) */
  .carta{
    display:none !important;
    height:86svh; max-height:720px;
    background:linear-gradient(180deg,rgba(34,197,94,.10),transparent 30%),var(--card);
    border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.35);
    padding:10px; grid-template-rows:1fr auto; gap:10px;
  }
  .carta.show{ display:grid !important; }
  @media (min-width:780px){
    .carta{ grid-template-columns: 1fr 360px; grid-template-rows: none; height:auto; }
  }

  /* Folha pautada + rolagem interna */
  .letter{
    position:relative;background:var(--paper);color:var(--ink);
    border-radius:16px;padding:12px 14px 14px 22px;box-shadow:inset 0 1px 0 rgba(0,0,0,.06);
    background-image:
      repeating-linear-gradient(#0000,#0000 26px,var(--line) 27px,#0000 28px),
      linear-gradient(90deg,#f7d5d5 0 16px,#0000 16px);
    background-size:auto,auto;
    overflow:auto; max-height:100%;
    scroll-behavior:smooth; /* smooth para os saltos de linha */
  }
  .letter::before{
    content:"";position:absolute;left:6px;top:18px;bottom:18px;width:6px;border-radius:999px;
    background:radial-gradient(circle at 50% 10%, #d9d9d9 0 3px,#0000 3px),
               radial-gradient(circle at 50% 40%, #d9d9d9 0 3px,#0000 3px),
               radial-gradient(circle at 50% 70%, #d9d9d9 0 3px,#0000 3px),
               radial-gradient(circle at 50% 100%,#d9d9d9 0 3px,#0000 3px);
  }
  .letter h2{margin:0 0 6px;color:#0a7a3b;font-size:1.08rem}
  .controls-line{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
  .mini{background:#e8f9ef;border:1px solid #c9f6df;color:#0a7a3b;font-weight:800;border-radius:10px;padding:6px 10px;cursor:pointer}
  .tline{margin:0 0 8px;line-height:1.7;font-size:.98rem;opacity:0;min-height:1.4em}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;font-size:.9rem;color:#555;opacity:0}
  .pill{background:#e6ffe8;border:1px solid #c9f6df;border-radius:999px;padding:6px 10px}

  /* Lápis animado enquanto escreve */
  .pencil{position:absolute; right:14px; bottom:10px; width:34px; height:34px; opacity:0; pointer-events:none}
  .writing .pencil{opacity:1; animation:scribble 1.4s ease-in-out infinite}
  @keyframes scribble{0%{transform:translate(0,0) rotate(-12deg)}50%{transform:translate(-8px,-4px) rotate(8deg)}100%{transform:translate(0,0) rotate(-12deg)}}

  .media{ display:flex; flex-direction:column; gap:8px; }
  .hero{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#111;cursor:zoom-in}
  .hero img{width:100%;height:auto;display:block;object-fit:contain;filter:saturate(1.05) contrast(1.05)}
  @media (max-width:779px){ .hero{max-height:22vh} .hero img{max-height:22vh} }

  .hero.glow{box-shadow:0 0 0 2px rgba(255,255,255,.08),0 0 26px rgba(255,255,255,.13)}
  .hero.glow::after{
    content:'';position:absolute;inset:-2px;padding:2px;border-radius:16px;
    background:conic-gradient(#22c55e,#e11d48,#86efac,#a7f3d0,#22c55e);
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;
    animation:ring 3.6s linear infinite;
  }
  @keyframes ring{to{transform:rotate(360deg)}}

  .player{background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;backdrop-filter:blur(6px)}
  .diskrow{display:flex;align-items:center;gap:10px}
  .cd{width:52px;height:52px;border-radius:50%;
    background:radial-gradient(circle at 50% 50%,#111 0 7px,transparent 7px),
      conic-gradient(#e5e7eb 0 10%,#cbd5e1 10% 20%,#9ca3af 20% 30%,#cbd5e1 30% 40%,
                     #e5e7eb 40% 50%,#cbd5e1 50% 60%,#9ca3af 60% 70%,#cbd5e1 70% 80%,#e5e7eb 80% 100%);
    box-shadow:inset 0 0 10px rgba(0,0,0,.35),0 2px 10px rgba(0,0,0,.25);position:relative;overflow:hidden}
  .cd::before{content:"";position:absolute;left:50%;top:50%;width:20px;height:20px;transform:translate(-50%,-50%);border-radius:50%;
    background:radial-gradient(circle at 60% 40%,#22c55e,#16a34a 60%);box-shadow:inset 0 0 4px rgba(0,0,0,.35)}
  .cd::after{content:"";position:absolute;left:50%;top:6px;width:4px;height:10px;transform:translateX(-50%);border-radius:2px;background:#e11d48}
  .spin{animation:spin 3.5s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
  .title{font-weight:800;font-size:.95rem}
  .viz{width:100%;height:44px;border-radius:10px;background:rgba(255,255,255,.05)}
  .controls{display:flex;align-items:center;gap:8px}
  .play{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:8px 11px;background:var(--accent);color:#06290d;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .time{font-size:.84rem;color:#e9f7ee;min-width:72px;text-align:right}
  .bar{position:relative;height:10px;flex:1;background:rgba(255,255,255,.15);border-radius:999px;cursor:pointer;overflow:hidden}
  .bar>i{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#34d399,#22c55e,#86efac)}
  .vol{width:80px;accent-color:#86efac}
  .replay{display:none;margin-top:4px;align-self:flex-start;background:#10b981;color:#06290d;font-weight:900;border:none;padding:8px 12px;border-radius:10px}

  footer{text-align:center;color:#bdbdcc;font-size:.82rem;margin-top:10px}

  .heart{position:fixed;bottom:-20px;font-size:20px;opacity:.85;animation:float 6s linear forwards;pointer-events:none}
  @keyframes float{to{transform:translateY(-120vh) translateX(var(--x));opacity:0}}
  .sparkle{position:fixed;width:6px;height:6px;border-radius:50%;background:radial-gradient(#fff,rgba(255,255,255,0));box-shadow:0 0 16px 4px rgba(255,255,255,.35);filter:hue-rotate(var(--h,0deg));animation:spark 2.2s linear forwards}
  @keyframes spark{from{transform:translateY(0);opacity:1}to{transform:translateY(-120px);opacity:0}}
  .petal{position:fixed;top:-20px;font-size:18px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));animation:fall var(--d) linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translate(var(--tx),105vh) rotate(540deg);opacity:.9}}

  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:1000}
  .lightbox img{max-width:95vw;max-height:95vh;border-radius:14px}
  .lightbox.show{display:flex}
  .lightbox .close{position:fixed;top:16px;right:20px;background:#fff;border:none;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}

  :root{--wrap:900px}
  @media (max-width:520px){ :root{--wrap:440px} .cta-heart{width:120px;height:110px} .viz{height:40px} }
</style>
</head>
<body>
<button id="fallback" class="fallback-open" aria-controls="carta">Abrir carta</button>

<div class="wrap">
  <!-- CAPA -->
  <section id="capa" class="capa" aria-label="Envelope">
    <div class="flap" id="flap"></div>
    <div class="selo">💌</div>
    <button id="abrir" class="cta-heart" aria-controls="carta" aria-label="Abrir carta">
      <svg viewBox="0 0 120 110" role="img" aria-hidden="true">
        <path d="M60 100 C 20 70, 10 55, 10 40 C 10 25, 22 15, 36 15 C 48 15, 55 22, 60 30 C 65 22, 72 15, 84 15 C 98 15, 110 25, 110 40 C 110 55, 100 70, 60 100 Z" fill="#16a34a" stroke="#e11d48" stroke-width="6"/>
      </svg>
      <span class="label">Abrir<br/>carta</span>
    </button>
  </section>

  <!-- CARTA -->
  <section id="carta" class="carta" aria-label="Carta de aniversário">
    <div class="letter" id="letter">
      <h2>Para Jéssica ❤️</h2>
      <div class="controls-line">
        <button id="speed" class="mini" type="button">⏩ Acelerar texto</button>
        <button id="restart" class="mini" type="button">↺ Rever do início</button>
      </div>

      <p class="tline" data-typer="Hoje é o seu aniversário, mas o presente somos nós. Desde o primeiro dia em que te vi, eu me apaixonei por você."></p>
      <p class="tline" data-typer="Quero que saiba: eu estarei sempre ao seu lado. Estamos há 16 anos juntos, 14 anos de casados, e depois de 10 anos Deus nos presenteou com a Alê (Alexandra), que trouxe tantas alegrias e nos ensina a sermos melhores a cada dia."></p>
      <p class="tline" data-typer="Que este dia seja tão especial quanto você é em nossas vidas. Obrigado por ser essa mulher maravilhosa, por todo o carinho e pelas suas orações."></p>
      <p class="tline" data-typer="Que o Senhor ouça cada uma delas — você é 'amiga de Deus' — e que todos os seus sonhos, projetos e desejos se realizem."></p>
      <p class="tline" data-typer="Te amo todos os dias!!!"></p>

      <div class="meta" id="meta">
        <span class="pill">Para: <strong>Jéssica</strong></span>
        <span class="pill">De: <strong>Felipe Palhares</strong></span>
      </div>

      <!-- lápis -->
      <svg class="pencil" viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#f59e0b"/><stop offset="1" stop-color="#d97706"/></linearGradient></defs>
        <path d="M8 52 L56 8" stroke="url(#g)" stroke-width="10" stroke-linecap="round"/>
        <circle cx="56" cy="8" r="6" fill="#111"/>
      </svg>
    </div>

    <div class="media">
      <figure class="hero" id="zoom"><img src="assets/imagem_cartao.png" alt="Imagem do cartão"/></figure>

      <aside class="player" aria-label="Música do cartão">
        <div class="diskrow">
          <div id="cd" class="cd" aria-hidden="true"></div>
          <div class="title">Todo dia, até morrer</div>
        </div>
        <canvas id="viz" class="viz" aria-hidden="true"></canvas>
        <div class="controls">
          <button id="btnPlay" class="play">▶ Tocar</button>
          <div class="bar" id="seek" aria-label="Barra de progresso"><i id="fill"></i></div>
          <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
          <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume">
        </div>
        <button id="replay" class="replay">🔁 Ouvir novamente</button>
        <audio id="audio" preload="auto">
          <source src="assets/musica.mp3" type="audio/mpeg">
        </audio>
      </aside>
    </div>
  </section>

  <footer>Feito com amor ❤️</footer>
</div>

<div id="lightbox" class="lightbox" aria-hidden="true">
  <button class="close" id="closeLb" aria-label="Fechar imagem">Fechar ✕</button>
  <img src="assets/imagem_cartao.png" alt="Imagem em tela cheia">
</div>

<script>
  const $ = s => document.querySelector(s);

  const capa=$('#capa'), carta=$('#carta'), abrir=$('#abrir'), flap=$('#flap'), fallback=$('#fallback');
  const letter=$('#letter'), speedBtn=$('#speed'), restartBtn=$('#restart');
  const lines=[...document.querySelectorAll('.tline')];
  const meta=$('#meta');
  const hero=$('#zoom'), btn=$('#btnPlay'), audio=$('#audio'), cd=$('#cd'),
        vizCanvas=$('#viz'), cur=$('#cur'), dur=$('#dur'), seek=$('#seek'), fill=$('#fill'), vol=$('#vol'), replay=$('#replay');

  // Estado inicial: só envelope visível
  function initState(){ carta.classList.remove('show'); capa.classList.remove('hide'); }
  initState();

  // ====== Máquina de escrever + AUTO-SCROLL ======
  let cps=8; // caracteres por segundo (calmo)
  function scrollToBottom(smooth=false){
    if(smooth && 'scrollTo' in letter){
      letter.scrollTo({ top: letter.scrollHeight, behavior:'smooth' });
    } else {
      letter.scrollTop = letter.scrollHeight;
    }
  }
  async function typeLine(el,text){
    letter.classList.add('writing');
    el.style.opacity=1; el.textContent="";
    let i=0, delay=1000/cps;
    await new Promise(resolve=>{
      const iv=setInterval(()=>{
        el.textContent+=text[i++]||"";
        // auto-scroll a cada caractere (rápido e estável)
        letter.scrollTop = letter.scrollHeight;
        if(i>text.length){ clearInterval(iv); resolve(); }
      }, delay);
    });
    // ao terminar a linha, garante um smooth até o fim
    scrollToBottom(true);
  }
  async function runTypewriter(){
    meta.style.opacity=0;
    letter.scrollTop = 0; // começa do topo
    for(const el of lines){
      await typeLine(el, el.dataset.typer);
      await new Promise(r=>setTimeout(r,220));
    }
    letter.classList.remove('writing');
    meta.style.transition="opacity .5s"; meta.style.opacity=1;
    fireworks();
  }
  function resetTypewriter(){
    lines.forEach(p=>{ p.textContent=''; p.style.opacity=0; });
    runTypewriter();
  }
  speedBtn.addEventListener('click',()=>{
    cps = (cps>=16)?8:(cps+4);
    speedBtn.textContent = (cps>8? '⏸ Desacelerar':'⏩ Acelerar texto');
  });
  restartBtn.addEventListener('click', resetTypewriter);

  // ====== Player + Visual ======
  let audioCtx, analyser, dataArray, peaks=[], smoothed=[];
  const BARS=32, CHORUS_TIME=60, CHORUS_LEN=14;
  function ensureAudioGraph(){
    if(audioCtx) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaElementSource(audio);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=512; analyser.minDecibels=-90; analyser.maxDecibels=-10; analyser.smoothingTimeConstant=.65;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    peaks=Array(BARS).fill(0); smoothed=Array(BARS).fill(0);
    src.connect(analyser); analyser.connect(audioCtx.destination);
  }
  function fmt(t){ if(!isFinite(t)) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return m+":"+(s<10?"0":"")+s; }
  audio.addEventListener('loadedmetadata',()=>{ dur.textContent=fmt(audio.duration); });
  audio.addEventListener('timeupdate',()=>{
    cur.textContent=fmt(audio.currentTime);
    fill.style.width=((audio.currentTime/(audio.duration||1))*100)+"%";
    const t=audio.currentTime;
    hero.classList.toggle('glow', t>=CHORUS_TIME && t<=CHORUS_TIME+CHORUS_LEN);
    const bass = getBandEnergy(0,4);
    document.body.style.setProperty('--glowX', `${50 + Math.sin(t*.7)*20}%`);
    document.body.style.setProperty('--glowY', `${40 + Math.cos(t*.6)*15}%`);
    document.body.style.setProperty('--glowC', `rgba(34,197,94, ${.12 + .35*bass})`);
  });
  btn.addEventListener('click', async ()=>{
    try{
      if(audio.paused){ ensureAudioGraph(); await audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); abrir.classList.add('beat'); }
      else{ audio.pause(); btn.textContent='▶ Tocar'; cd.classList.remove('spin'); abrir.classList.remove('beat'); hero.classList.remove('glow'); }
    }catch(e){}
  });
  audio.addEventListener('ended', ()=>{ btn.textContent='▶ Tocar'; cd.classList.remove('spin'); abrir.classList.remove('beat'); hero.classList.remove('glow'); replay.style.display='inline-flex'; });
  replay.addEventListener('click', async()=>{ replay.style.display='none'; try{ await audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); abrir.classList.add('beat'); }catch(e){} });

  function setFromClientX(x){ const r=seek.getBoundingClientRect(); const k=Math.min(1,Math.max(0,(x-r.left)/r.width)); audio.currentTime=k*(audio.duration||0); }
  seek.addEventListener('click', e=>setFromClientX(e.clientX));
  let dragging=false;
  seek.addEventListener('pointerdown', e=>{ dragging=true; setFromClientX(e.clientX); seek.setPointerCapture(e.pointerId); });
  seek.addEventListener('pointermove', e=>{ if(dragging) setFromClientX(e.clientX); });
  seek.addEventListener('pointerup', ()=>{ dragging=false });

  vol.addEventListener('input', ()=>{ audio.volume=+vol.value; });

  const ctx=vizCanvas.getContext('2d',{alpha:true});
  function binFor(i){ const f=i/(BARS-1); const e=Math.pow(f,1.8); return Math.min(dataArray.length-1, Math.floor(e*(dataArray.length-1))); }
  function getBandEnergy(a,b){ if(!analyser) return 0; let m=0; for(let i=a;i<=b;i++){ m=Math.max(m,(dataArray[i]||0)/255);} return m; }
  function drawViz(){
    requestAnimationFrame(drawViz);
    if(!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    const w=vizCanvas.width=vizCanvas.clientWidth, h=vizCanvas.height=vizCanvas.clientHeight, bw=w/BARS-2;
    ctx.clearRect(0,0,w,h);
    for(let i=0;i<BARS;i++){
      const idx=binFor(i), v=(dataArray[idx]||0)/255, vBoost=Math.pow(v,1.2), bh=Math.max(2,(h-8)*vBoost);
      smoothed[i]=smoothed[i]*0.6 + bh*0.4; peaks[i]=Math.max(peaks[i]*0.98, smoothed[i]);
      const x=i*(bw+2), y=h-smoothed[i]-4, r=4, hue=130+i*(220/BARS);
      ctx.fillStyle=`hsla(${hue},85%,${40+v*35}%,.88)`;
      ctx.beginPath();
      ctx.moveTo(x+r,y); ctx.lineTo(x+bw-r,y); ctx.quadraticCurveTo(x+bw,y,x+bw,y+r);
      ctx.lineTo(x+bw,y+smoothed[i]-r); ctx.quadraticCurveTo(x+bw,y+smoothed[i],x+bw-r,y+smoothed[i]);
      ctx.lineTo(x+r,y+smoothed[i]); ctx.quadraticCurveTo(x,y+smoothed[i],x,y+smoothed[i]-r);
      ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill();
      const capY=h-peaks[i]-6; ctx.fillStyle=`hsla(${hue},95%,90%,.95)`; ctx.fillRect(x,capY,bw,3);
    }
  }
  drawViz();

  // Efeitos cenográficos
  function heartBurst(q=3){ for(let i=0;i<q;i++){ const h=document.createElement('div'); h.className='heart'; h.textContent=['💚','💖','💘','❤️'][i%4]; h.style.left=(Math.random()*100)+'vw'; h.style.setProperty('--x',(Math.random()*140-70)+'vw'); h.style.animationDelay=(Math.random()*1.2)+'s'; document.body.appendChild(h); setTimeout(()=>h.remove(),6500);} }
  function sparkles(q=3){ for(let i=0;i<q;i++){ const s=document.createElement('div'); s.className='sparkle'; s.style.left=(Math.random()*100)+'vw'; s.style.top=(Math.random()*40+10)+'vh'; s.style.setProperty('--h',(Math.random()*120-60)+'deg'); document.body.appendChild(s); setTimeout(()=>s.remove(),2200);} }
  function petals(q=2){ for(let i=0;i<q;i++){ const p=document.createElement('div'); p.className='petal'; p.textContent=Math.random()>.5?'🌹':'🥀'; p.style.left=(Math.random()*100)+'vw'; p.style.setProperty('--tx',(Math.random()*60-30)+'vw'); p.style.setProperty('--d',(7+Math.random()*6)+'s'); document.body.appendChild(p); setTimeout(()=>p.remove(),13000);} }
  setInterval(()=>heartBurst(2),2800);
  setInterval(()=>sparkles(2),2200);
  setInterval(()=>petals(2),2000);

  // Abrir carta
  function fireworks(){ /* fogos rápidos */ }
  function confettiOnce(){ /* confete — omitido pra brevidade visual */ }
  function abrirCarta(){
    flap.style.transform='rotateX(155deg)';
    setTimeout(()=>{
      capa.classList.add('hide');
      carta.classList.add('show');
      fallback.style.display='none';
      resetTypewriter();
      try{ ensureAudioGraph(); audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); abrir.classList.add('beat'); }catch(e){}
    },600);
  }
  abrir.addEventListener('click', abrirCarta);
  fallback.addEventListener('click', abrirCarta);

  // Lightbox
  const lightbox=$('#lightbox'), closeLb=$('#closeLb');
  hero.addEventListener('click',()=>lightbox.classList.add('show'));
  closeLb.addEventListener('click',()=>lightbox.classList.remove('show'));
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') lightbox.classList.remove('show'); });
  lightbox.addEventListener('click',e=>{ if(e.target===lightbox) lightbox.classList.remove('show'); });
</script>

<noscript>
  <style>.capa{display:none}.carta{display:block}</style>
  <div style="max-width:700px;margin:20px auto;background:#fff;padding:16px;border-radius:10px;color:#000">
    Ative o JavaScript para ver a animação da carta e ouvir a música.
  </div>
</noscript>
</body>
</html>
