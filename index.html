<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carta para J√©ssica üíå</title>
<meta name="theme-color" content="#22c55e">

<style>
  :root{
    --bg:#0f1115; --card:#151821; --paper:#fff7f9;
    --accent:#22c55e; /* VERDE */
    --ink:#2b2b2b; --muted:#b9b9c3; --text:#f7f7fb; --glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at -10% -10%, #23182b 0, transparent 60%),
      radial-gradient(1200px 700px at 110% 10%, #12202c 0, transparent 55%),
      var(--bg);
    min-height:100svh; display:flex; align-items:center; justify-content:center; padding:16px;
    overflow-x:hidden;
  }
  .wrap{width:min(980px,100%); animation:fadeUp .7s ease-out both}
  @keyframes fadeUp{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}

  /* CAPA */
  .capa{
    position:relative; background:linear-gradient(180deg,#63e2a8,#22c55e);
    border-radius:22px; box-shadow:0 15px 40px rgba(0,0,0,.35);
    padding:28px; display:grid; place-items:center; aspect-ratio:16/9; overflow:hidden;
  }
  .flap{
    position:absolute; left:0; right:0; top:0; height:52%;
    background:linear-gradient(180deg,#c9f6df,#7ee0af);
    clip-path:polygon(0 0,100% 0,50% 100%);
    transform-origin:50% 0; transition:transform .9s cubic-bezier(.22,1,.36,1);
    box-shadow:0 12px 30px rgba(0,0,0,.35);
  }
  .selo{
    position:absolute; left:50%; top:48%; transform:translate(-50%,-50%);
    background:#e7ffe7; color:#096d36; border-radius:999px; padding:10px 16px;
    font-weight:800; letter-spacing:.04em; box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .cta{
    position:relative; z-index:2; appearance:none; border:none; cursor:pointer;
    background:#0ea94d; color:#fff; font-weight:900; font-size:1.1rem;
    padding:14px 20px; border-radius:14px; box-shadow:0 10px 20px rgba(0,0,0,.25);
    transition:transform .12s ease, box-shadow .12s ease;
  }
  .cta:hover{ transform:translateY(-1px); box-shadow:0 14px 24px rgba(0,0,0,.28) }
  .cta:active{ transform:translateY(0) }

  /* BOT√ÉO FALLBACK (sempre vis√≠vel) */
  .fallback-open{
    position:fixed; left:12px; bottom:12px; z-index:50;
    background:var(--accent); color:#fff; border:none; border-radius:12px;
    padding:10px 14px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.3);
  }

  /* CARTA */
  .carta{
    display:none; grid-template-columns:1fr 380px; gap:20px;
    background:linear-gradient(180deg,rgba(34,197,94,.10),transparent 30%), var(--card);
    border-radius:22px; box-shadow:0 15px 40px rgba(0,0,0,.35); padding:18px; animation:fadeUp .6s .15s both;
  }
  @media (max-width: 920px){ .carta{grid-template-columns:1fr} }

  .hero{
    position:relative; border-radius:18px; overflow:hidden;
    border:1px solid rgba(255,255,255,.08); background:#111; cursor:zoom-in;
  }
  .hero img{ width:100%; height:auto; object-fit:contain; display:block; filter:saturate(1.05) contrast(1.05); }
  @media (min-width:901px){ .hero img{ max-height:520px } }
  @media (max-width:900px){ .hero img{ max-height:360px } }

  .letter{
    background:linear-gradient(#fff,#fff7f9); color:var(--ink);
    border-radius:18px; padding:18px; box-shadow:inset 0 1px 0 rgba(0,0,0,.06);
  }
  .letter h2{ margin:0 0 10px; color:#0a7a3b }
  .tline{ margin:0 0 12px; line-height:1.7; font-size:1.04rem; opacity:.0; }
  .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; font-size:.92rem; color:#555; opacity:0 }
  .pill{ background:#e6ffe8; border:1px solid #c9f6df; border-radius:999px; padding:6px 10px }

  /* PLAYER minimalista + CD + equalizador colorido */
  .player{
    background:var(--glass); border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:14px; display:flex; flex-direction:column; gap:12px; margin-top:14px;
    backdrop-filter: blur(6px);
  }
  .diskrow{ display:flex; align-items:center; gap:12px }
  .cd{
    width:60px; height:60px; border-radius:50%;
    background:
      radial-gradient(circle at 50% 50%, #fff 0 6px, transparent 6px),
      radial-gradient(circle at 50% 50%, #d8d8d8 7px, #a8a8a8 24px, #efefef 50px, #c9c9c9);
    box-shadow:inset 0 0 8px rgba(0,0,0,.25), 0 2px 10px rgba(0,0,0,.25);
    position:relative;
    overflow:hidden;
  }
  .cd::after{ /* brilho colorido do CD */
    content:""; position:absolute; inset:-20% -20%;
    background:conic-gradient(from 0turn, #ff7ab3, #fff176, #7ee0af, #6ecbff, #b388ff, #ff7ab3);
    mix-blend-mode:overlay; opacity:.7;
  }
  .spin{ animation:spin 5s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .title{ font-weight:800; font-size:1rem }
  .viz{ width:100%; height:44px; border-radius:10px; background:rgba(255,255,255,.05) }
  .controls{ display:flex; align-items:center; gap:10px }
  .play{
    appearance:none; border:none; cursor:pointer; border-radius:11px; padding:10px 14px;
    background:var(--accent); color:#06290d; font-weight:900; box-shadow:0 6px 18px rgba(0,0,0,.25);
    transition:transform .12s ease;
  }
  .play:active{ transform:translateY(1px) }
  .time{ font-size:.9rem; color:#e9f7ee; min-width:84px; text-align:right }
  .bar{ position:relative; height:10px; flex:1; background:rgba(255,255,255,.15); border-radius:999px; cursor:pointer; overflow:hidden }
  .bar > i{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#34d399,#22c55e,#86efac); }
  .vol{ width:90px; accent-color:#86efac }

  .hint{ color:var(--muted); font-size:.9rem }
  footer{ text-align:center; color:#bdbdcc; font-size:.85rem; margin-top:10px }

  /* ANIMA√á√ïES cont√≠nuas: cora√ß√µes + brilhinhos */
  .heart{ position:fixed; bottom:-20px; font-size:20px; opacity:.85; animation:float 6s linear forwards; pointer-events:none }
  @keyframes float{ to{ transform:translateY(-120vh) translateX(var(--x)); opacity:0 } }
  .sparkle{ position:fixed; width:6px; height:6px; border-radius:50%;
            background:radial-gradient(#fff, rgba(255,255,255,0));
            box-shadow:0 0 16px 4px rgba(255,255,255,.35); filter:hue-rotate(var(--h,0deg));
            animation:spark 2.2s linear forwards }
  @keyframes spark{ from{ transform:translateY(0); opacity:1 } to{ transform:translateY(-120px); opacity:0 } }

  /* LIGHTBOX */
  .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.9); display:none; align-items:center; justify-content:center; z-index:1000 }
  .lightbox img{ max-width:95vw; max-height:95vh; border-radius:16px }
  .lightbox.show{ display:flex }
  .lightbox .close{ position:fixed; top:20px; right:24px; background:#fff; border:none; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer }

  /* responsividade mais apertada */
  @media (max-width:520px){
    .controls{ gap:8px }
    .time{ min-width:70px; font-size:.82rem }
    .vol{ width:70px }
    .cd{ width:52px; height:52px }
  }
</style>
</head>
<body>
  <!-- Fallback: se algo travar na capa, este bot√£o abre a carta -->
  <button id="fallback" class="fallback-open" aria-controls="carta">Abrir carta</button>

  <div class="wrap">

    <!-- CAPA -->
    <section id="capa" class="capa" aria-label="Envelope">
      <div class="flap" id="flap"></div>
      <div class="selo">üíå</div>
      <button id="abrir" class="cta" aria-controls="carta" aria-label="Abrir carta">Abrir carta</button>
    </section>

    <!-- CARTA -->
    <section id="carta" class="carta" aria-label="Carta de anivers√°rio" hidden>
      <div class="letter">
        <h2>Para J√©ssica ‚ù§Ô∏è</h2>

        <!-- Texto com efeito m√°quina de escrever -->
        <p class="tline" data-typer="Desde o primeiro olhar eu me apaixonei por voc√™. Hoje, celebramos 14 anos de casados e meu cora√ß√£o continua dizendo sim, todos os dias."></p>
        <p class="tline" data-typer="Deus nos presenteou com a nossa Alexandra, um raio de alegria que enche a casa de risos. J√° s√£o 3 aninhos de b√™n√ß√£os e descobertas ao seu lado."></p>
        <p class="tline" data-typer="Juntos conquistamos tanta coisa: constru√≠mos nossa casa, nossos sonhos e um amor que amadurece e floresce. A cada dia eu me apaixono mais por voc√™."></p>
        <p class="tline" data-typer="Obrigado por ser meu porto seguro, minha amiga e o grande amor da minha vida. Eu te amo ‚Äî ontem, hoje e sempre."></p>

        <div class="meta" id="meta">
          <span class="pill">Para: <strong>J√©ssica</strong></span>
          <span class="pill">De: <strong>Seu marido</strong></span>
        </div>

        <div class="hint" style="margin-top:10px">No celular, a m√∫sica come√ßa ap√≥s um toque.</div>
      </div>

      <div>
        <figure class="hero" id="zoom"><img src="assets/imagem_cartao.png" alt="Imagem do cart√£o" /></figure>

        <!-- PLAYER -->
        <aside class="player" aria-label="M√∫sica do cart√£o">
          <div class="diskrow">
            <div id="cd" class="cd" aria-hidden="true"></div>
            <div class="title">Todo dia, at√© morrer</div>
          </div>

          <canvas id="viz" class="viz" aria-hidden="true"></canvas>

          <div class="controls">
            <button id="btnPlay" class="play">‚ñ∂ Tocar</button>
            <div class="bar" id="seek" aria-label="Barra de progresso"><i id="fill"></i></div>
            <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
            <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume">
          </div>

          <audio id="audio" preload="auto">
            <source src="assets/musica.mp3" type="audio/mpeg">
          </audio>
        </aside>
      </div>
    </section>

    <footer>Feito com amor ‚ù§Ô∏è</footer>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="close" id="closeLb" aria-label="Fechar imagem">Fechar ‚úï</button>
    <img src="assets/imagem_cartao.png" alt="Imagem em tela cheia">
  </div>

<script>
  /* util */
  const $ = sel => document.querySelector(sel);

  /* elementos principais */
  const capa   = $('#capa');
  const carta  = $('#carta');
  const abrir  = $('#abrir');
  const flap   = $('#flap');
  const fallback = $('#fallback');

  /* player */
  const audio  = $('#audio');
  const btn    = $('#btnPlay');
  const cur    = $('#cur');
  const dur    = $('#dur');
  const seek   = $('#seek');
  const fill   = $('#fill');
  const vol    = $('#vol');
  const cd     = $('#cd');

  /* visualizador */
  const vizCanvas = $('#viz');
  const ctx = vizCanvas.getContext('2d', { alpha: true });

  /* lightbox */
  const zoom = $('#zoom');
  const lightbox = $('#lightbox');
  const closeLb  = $('#closeLb');

  function fmt(secs){ if(!isFinite(secs)) return "0:00"; const m = Math.floor(secs/60); const s = Math.floor(secs%60); return m+":"+(s<10?"0":"")+s; }

  /* ---- Efeitos cont√≠nuos ---- */
  function heartBurst(qty=10){
    for(let i=0;i<qty;i++){
      const h=document.createElement('div');
      h.className='heart';
      h.textContent=['üíö','üíñ','üíò','‚ù§Ô∏è'][i%4];
      h.style.left=(Math.random()*100)+'vw';
      h.style.setProperty('--x',(Math.random()*140-70)+'vw');
      h.style.animationDelay=(Math.random()*1.2)+'s';
      document.body.appendChild(h);
      setTimeout(()=>h.remove(),6500);
    }
  }
  function sparklesBurst(qty=12){
    for(let i=0;i<qty;i++){
      const s=document.createElement('div');
      s.className='sparkle';
      s.style.left=(Math.random()*100)+'vw';
      s.style.top=(Math.random()*40+10)+'vh';
      s.style.setProperty('--h', (Math.random()*120-60)+'deg');
      document.body.appendChild(s);
      setTimeout(()=>s.remove(),2200);
    }
  }
  setInterval(()=>heartBurst(3), 2500);
  setInterval(()=>sparklesBurst(3), 2000);

  /* ---- Confete ao abrir ---- */
  function confettiOnce(){
    const colors=['üéâ','‚ú®','üíö','üíó','üíô','üíõ','üß°'];
    for(let i=0;i<28;i++){
      const c=document.createElement('div');
      c.textContent=colors[i%colors.length];
      c.style.position='fixed';
      c.style.left='50%'; c.style.top='50%';
      c.style.transform='translate(-50%,-50%)';
      c.style.fontSize=(Math.random()*14+14)+'px';
      c.style.animation=`conf${i} 900ms ease-out forwards`;
      document.body.appendChild(c);
      const dx=(Math.random()*2-1)*45, dy=(Math.random()*2-1)*35, rot=(Math.random()*360)+'deg';
      const style=document.createElement('style');
      style.textContent=`@keyframes conf${i}{to{transform:translate(${dx}vw,${dy}vh) rotate(${rot});opacity:0}}`;
      document.head.appendChild(style);
      setTimeout(()=>{c.remove();style.remove();},950);
    }
  }

  /* ---- M√°quina de escrever ---- */
  const lines = Array.from(document.querySelectorAll('.tline'));
  async function typeLine(el, text, cps=28){ // caracteres por segundo
    el.style.opacity = 1;
    el.textContent = "";
    let i=0; const delay = 1000/cps;
    return new Promise(resolve=>{
      const iv = setInterval(()=>{
        el.textContent += text[i++] || "";
        if(i>text.length){ clearInterval(iv); resolve(); }
      }, delay);
    });
  }
  async function runTypewriter(){
    for(const el of lines){
      await typeLine(el, el.getAttribute('data-typer'));
    }
    // mostra os chips "meta"
    const meta = document.getElementById('meta');
    meta.style.transition="opacity .6s";
    meta.style.opacity=1;
  }

  /* ---- Abrir carta ---- */
  async function abrirCarta(){
    flap.style.transform='rotateX(155deg)';        // anima a aba do envelope
    setTimeout(()=>{
      capa.style.display='none';
      carta.hidden=false;
      carta.style.display='grid';
      confettiOnce();
      runTypewriter();
    }, 650);

    try{ await audio.play(); btn.textContent='‚è∏ Pausar'; cd.classList.add('spin'); }catch(e){ /* mobile: precisa de toque */ }
  }

  abrir.addEventListener('click', abrirCarta);
  fallback.addEventListener('click', abrirCarta);

  /* ---- Player ---- */
  audio.addEventListener('loadedmetadata', ()=>{ dur.textContent = fmt(audio.duration); });

  audio.addEventListener('timeupdate', ()=>{
    cur.textContent = fmt(audio.currentTime);
    const p = (audio.currentTime / (audio.duration||1))*100;
    fill.style.width = p + "%";
  });

  btn.addEventListener('click', async ()=>{
    try{
      if(audio.paused){ await audio.play(); btn.textContent='‚è∏ Pausar'; cd.classList.add('spin'); }
      else{ audio.pause(); btn.textContent='‚ñ∂ Tocar'; cd.classList.remove('spin'); }
    }catch(e){}
  });
  audio.addEventListener('ended', ()=>{ btn.textContent='‚ñ∂ Tocar'; cd.classList.remove('spin'); });

  // buscar/arrastar na barra
  function setFromClientX(x){
    const rect = seek.getBoundingClientRect();
    const ratio = Math.min(1, Math.max(0, (x-rect.left)/rect.width));
    audio.currentTime = ratio * (audio.duration||0);
  }
  seek.addEventListener('click', e => setFromClientX(e.clientX));
  let dragging=false;
  seek.addEventListener('pointerdown', e=>{ dragging=true; setFromClientX(e.clientX); seek.setPointerCapture(e.pointerId); });
  seek.addEventListener('pointermove', e=>{ if(dragging) setFromClientX(e.clientX); });
  seek.addEventListener('pointerup',   e=>{ dragging=false; });

  // volume
  vol.addEventListener('input', ()=>{ audio.volume = +vol.value; });

  // visualizador colorido com WebAudio
  let audioCtx, analyser, dataArray;
  function ensureAudioGraph(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 64;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(audioCtx.destination);
  }
  btn.addEventListener('click', ensureAudioGraph, {once:true});
  abrir.addEventListener('click', ensureAudioGraph, {once:true});
  fallback.addEventListener('click', ensureAudioGraph, {once:true});

  function drawViz(){
    requestAnimationFrame(drawViz);
    if(!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    const w = vizCanvas.width = vizCanvas.clientWidth;
    const h = vizCanvas.height = vizCanvas.clientHeight;
    const bars = 26, step = Math.floor(dataArray.length / bars);
    const bw = w / bars;
    ctx.clearRect(0,0,w,h);
    for(let i=0;i<bars;i++){
      const v = dataArray[i*step]/255;
      const bh = (h-6)*v;
      const x = i*bw, y = h - bh - 3, r = 4;
      const hue = 130 + i*(220/bars); // degrade colorido (verde -> azul -> rosa)
      ctx.fillStyle = `hsla(${hue}, 80%, ${40+v*35}%, ${0.7*(0.3+v)})`;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+bw-r, y);
      ctx.quadraticCurveTo(x+bw, y, x+bw, y+r);
      ctx.lineTo(x+bw, y+bh-r);
      ctx.quadraticCurveTo(x+bw, y+bh, x+bw-r, y+bh);
      ctx.lineTo(x+r, y+bh);
      ctx.quadraticCurveTo(x, y+bh, x, y+bh-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath();
      ctx.fill();
    }
  }
  drawViz();

  // micro-parallax na capa
  document.addEventListener('pointermove',(e)=>{
    if(capa.style.display==='none') return;
    const x=(e.clientX/window.innerWidth - .5)*6;
    const y=(e.clientY/window.innerHeight- .5)*6;
    capa.style.transform=`translate3d(${x}px,${y}px,0)`;
  },{passive:true});

  /* Lightbox (zoom ao clicar na imagem) */
  zoom.addEventListener('click', ()=>{ lightbox.classList.add('show'); });
  closeLb.addEventListener('click', ()=>{ lightbox.classList.remove('show'); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lightbox.classList.remove('show'); });
  lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox) lightbox.classList.remove('show'); });
</script>

<noscript>
  <style>.capa{display:none}.carta{display:block}</style>
  <div style="max-width:700px;margin:20px auto;background:#fff;padding:16px;border-radius:10px;color:#000">
    Ative o JavaScript para ver a anima√ß√£o da carta e ouvir a m√∫sica.
  </div>
</noscript>
</body>
</html>
