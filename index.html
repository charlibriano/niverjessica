<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carta para Jéssica 💌</title>
<meta name="theme-color" content="#22c55e">

<style>
  :root{
    --bg:#0f1115; --card:#151821; --paper:#fff7f9;
    --accent:#22c55e; --ink:#2b2b2b; --muted:#b9b9c3; --text:#f7f7fb; --glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at -10% -10%, #23182b 0, transparent 60%),
      radial-gradient(1200px 700px at 110% 10%, #12202c 0, transparent 55%),
      var(--bg);
    min-height:100svh; display:flex; align-items:center; justify-content:center; padding:12px;
    overflow-x:hidden; position:relative;
  }
  /* luzes de humor controladas pelo áudio */
  .mood{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(50vw 50vh at 20% 15%, rgba(46,204,113,.16), transparent 65%),
      radial-gradient(55vw 55vh at 80% 85%, rgba(241,70,104,.12), transparent 60%);
    mix-blend-mode:screen; filter:hue-rotate(var(--hue,0deg)) saturate(1.2);
    transition:filter .15s linear, opacity .3s ease;
    opacity:.9;
  }

  .wrap{position:relative; z-index:1; width:min(980px,100%); animation:fadeUp .7s ease-out both}
  @keyframes fadeUp{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}

  /* CAPA */
  .capa{
    position:relative; background:linear-gradient(180deg,#63e2a8,#22c55e);
    border-radius:20px; box-shadow:0 12px 36px rgba(0,0,0,.35);
    padding:22px; display:grid; place-items:center; aspect-ratio:4/3; overflow:hidden;
  }
  .flap{
    position:absolute; left:0; right:0; top:0; height:52%;
    background:linear-gradient(180deg,#c9f6df,#7ee0af);
    clip-path:polygon(0 0,100% 0,50% 100%);
    transform-origin:50% 0; transition:transform .9s cubic-bezier(.22,1,.36,1);
    box-shadow:0 12px 30px rgba(0,0,0,.35);
  }
  .selo{
    position:absolute; left:50%; top:48%; transform:translate(-50%,-50%);
    background:#e7ffe7; color:#096d36; border-radius:999px; padding:10px 14px;
    font-weight:800; letter-spacing:.04em; box-shadow:0 6px 18px rgba(0,0,0,.25);
  }

  /* BOTÃO CORAÇÃO (SVG) + batimento no ritmo */
  .cta-wrap{ position:relative; z-index:2; transform:scale(var(--beat,1)); transition:transform .06s linear }
  .cta-heart{
    width:132px; height:120px; background:transparent; border:none; cursor:pointer; padding:0;
    display:block;
  }
  .cta-heart svg{ width:100%; height:100%; display:block; filter:drop-shadow(0 10px 20px rgba(0,0,0,.25)) }
  .cta-heart .label{
    position:absolute; inset:0; display:grid; place-items:center; text-align:center;
    color:#fff; font-weight:900; font-size:1.02rem; line-height:1.05; white-space:nowrap;
    pointer-events:none;
  }

  /* BOTÃO FALLBACK (sempre visível) */
  .fallback-open{
    position:fixed; left:10px; bottom:10px; z-index:50;
    background:var(--accent); color:#fff; border:none; border-radius:12px;
    padding:9px 12px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.3);
  }

  /* CARTA */
  .carta{
    display:none; grid-template-columns:1fr 360px; gap:16px;
    background:linear-gradient(180deg,rgba(34,197,94,.08),transparent 30%), var(--card);
    border-radius:18px; box-shadow:0 12px 32px rgba(0,0,0,.35); padding:12px; animation:fadeUp .6s .15s both;
  }
  @media (max-width: 920px){ .carta{grid-template-columns:1fr} }

  /* Folha pautada de caderno */
  .letter{
    position:relative; color:var(--ink);
    border-radius:14px; padding:16px 18px 16px 38px;
    background:
      linear-gradient(#fff,#fff) padding-box,
      repeating-linear-gradient(#dbeafe 0 1px, transparent 1px 28px) border-box;
    box-shadow:inset 0 1px 0 rgba(0,0,0,.06);
  }
  .letter::before{ /* margem vermelha */
    content:""; position:absolute; left:22px; top:0; bottom:0; width:2px; background:#ff6b6b; opacity:.7;
  }
  .letter::after{ /* furinhos */
    content:""; position:absolute; left:8px; top:18px; width:8px; height:8px; border-radius:50%;
    background:#e5e7eb; box-shadow:0 64px 0 #e5e7eb, 0 128px 0 #e5e7eb, 0 192px 0 #e5e7eb, 0 256px 0 #e5e7eb;
    opacity:.9;
  }
  .letter h2{ margin:0 0 8px; color:#0a7a3b; font-size:1.25rem }
  .controls-line{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:4px}
  .mini{background:#e8f9ef; border:1px solid #c9f6df; color:#0a7a3b; font-weight:800; border-radius:10px; padding:6px 10px; cursor:pointer}
  .tline{ margin:0 0 10px; line-height:1.7; font-size:1.02rem; opacity:.0; min-height:1.4em }
  .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:.9rem; color:#555; opacity:0 }
  .pill{ background:#e6ffe8; border:1px solid #c9f6df; border-radius:999px; padding:6px 10px }

  /* Assinatura */
  .signature{ margin-top:8px; height:50px }
  .sig path{
    fill:none; stroke:#0a7a3b; stroke-width:2.4; stroke-linecap:round; stroke-linejoin:round;
    stroke-dasharray: 700; stroke-dashoffset: 700; animation:draw 3.8s ease forwards; animation-delay:.4s;
  }
  @keyframes draw{ to{ stroke-dashoffset:0 } }

  /* PLAYER + CD + equalizador */
  .hero{
    position:relative; border-radius:14px; overflow:hidden;
    border:1px solid rgba(255,255,255,.08); background:#111; cursor:zoom-in;
  }
  .hero img{ width:100%; height:auto; object-fit:contain; display:block; filter:saturate(1.05) contrast(1.05); }
  @media (min-width:901px){ .hero img{ max-height:480px } }
  @media (max-width:900px){ .hero img{ max-height:340px } }

  /* brilho do refrão */
  .hero.glow{ box-shadow:0 0 0 2px rgba(255,255,255,.08), 0 0 30px rgba(255,255,255,.14) }
  .hero.glow::after{
    content:''; position:absolute; inset:-2px; padding:2px; border-radius:16px;
    background:conic-gradient(#22c55e,#e11d48,#86efac,#a7f3d0,#22c55e);
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude;
    animation:ring 4s linear infinite;
  }
  @keyframes ring{ to{ transform:rotate(360deg) } }

  .player{
    background:var(--glass); border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; margin-top:12px;
    backdrop-filter: blur(6px);
  }
  .diskrow{ display:flex; align-items:center; gap:10px }
  .cd{
    width:60px; height:60px; border-radius:50%;
    background:
      radial-gradient(circle at 50% 50%, #111 0 8px, transparent 8px),
      conic-gradient(#e5e7eb 0 10%, #cbd5e1 10% 20%, #9ca3af 20% 30%, #cbd5e1 30% 40%,
                     #e5e7eb 40% 50%, #cbd5e1 50% 60%, #9ca3af 60% 70%, #cbd5e1 70% 80%, #e5e7eb 80% 100%);
    box-shadow:inset 0 0 10px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25);
    position:relative; overflow:hidden;
  }
  .cd::before{ content:""; position:absolute; left:50%; top:50%; width:24px; height:24px;
    transform:translate(-50%,-50%); border-radius:50%;
    background:radial-gradient(circle at 60% 40%, #22c55e, #16a34a 60%); box-shadow:inset 0 0 4px rgba(0,0,0,.35);}
  .cd::after{ content:""; position:absolute; left:50%; top:7px; width:4px; height:10px; transform:translateX(-50%); border-radius:2px; background:#e11d48; }
  .spin{ animation:spin 3.5s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .title{ font-weight:800; font-size:.98rem }
  .viz{ width:100%; height:56px; border-radius:10px; background:rgba(255,255,255,.05) }
  .controls{ display:flex; align-items:center; gap:8px }
  .play{
    appearance:none; border:none; cursor:pointer; border-radius:10px; padding:9px 12px;
    background:var(--accent); color:#06290d; font-weight:900; box-shadow:0 6px 18px rgba(0,0,0,.25);
    transition:transform .12s ease;
  }
  .play:active{ transform:translateY(1px) }
  .time{ font-size:.86rem; color:#e9f7ee; min-width:78px; text-align:right }
  .bar{ position:relative; height:10px; flex:1; background:rgba(255,255,255,.15); border-radius:999px; cursor:pointer; overflow:hidden }
  .bar > i{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#34d399,#22c55e,#86efac); }
  .vol{ width:86px; accent-color:#86efac }

  .replay{
    display:none; margin-top:6px; align-self:flex-start;
    background:#16a34a; color:#06290d; border:none; border-radius:10px; padding:9px 12px; font-weight:900; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }

  .hint{ color:var(--muted); font-size:.86rem }
  footer{ text-align:center; color:#bdbdcc; font-size:.82rem; margin-top:8px }

  /* corações + brilhinhos + pétalas contínuos */
  .heart{ position:fixed; bottom:-20px; font-size:20px; opacity:.85; animation:float 6s linear forwards; pointer-events:none }
  @keyframes float{ to{ transform:translateY(-120vh) translateX(var(--x)); opacity:0 } }
  .sparkle{ position:fixed; width:6px; height:6px; border-radius:50%;
            background:radial-gradient(#fff, rgba(255,255,255,0));
            box-shadow:0 0 16px 4px rgba(255,255,255,.35); filter:hue-rotate(var(--h,0deg));
            animation:spark 2.2s linear forwards }
  @keyframes spark{ from{ transform:translateY(0); opacity:1 } to{ transform:translateY(-120px); opacity:0 } }
  .petal{ position:fixed; top:-3vh; font-size:18px; filter:saturate(1.2); animation:petal 8s linear forwards; pointer-events:none; opacity:.95 }
  @keyframes petal{ to{ transform: translate(var(--px,0vw), 108vh) rotate(720deg); opacity:.6 } }

  /* LIGHTBOX */
  .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.9); display:none; align-items:center; justify-content:center; z-index:1000 }
  .lightbox img{ max-width:95vw; max-height:95vh; border-radius:12px }
  .lightbox.show{ display:flex }
  .lightbox .close{ position:fixed; top:12px; right:16px; background:#fff; border:none; border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer }

  /* Mobile tuning */
  @media (max-width:520px){
    body{ padding:8px }
    .capa{ aspect-ratio: 3/2; padding:18px }
    .cta-heart{ width:118px; height:108px }
    .carta{ gap:12px; padding:10px }
    .letter{ padding:14px 14px 14px 34px }
    .letter h2{ font-size:1.12rem }
    .tline{ font-size:.98rem }
    .hero img{ max-height:300px }
    .viz{ height:50px }
    .cd{ width:56px; height:56px }
    .time{ min-width:68px; font-size:.8rem }
    .vol{ width:70px }
  }
</style>
</head>
<body>
  <!-- Luzes de fundo -->
  <div id="mood" class="mood" aria-hidden="true"></div>

  <!-- Fallback -->
  <button id="fallback" class="fallback-open" aria-controls="carta">Abrir carta</button>

  <div class="wrap">

    <!-- CAPA -->
    <section id="capa" class="capa" aria-label="Envelope">
      <div class="flap" id="flap"></div>
      <div class="selo">💌</div>

      <div class="cta-wrap" id="ctawrap">
        <!-- Coração verde com contorno vermelho -->
        <button id="abrir" class="cta-heart" aria-controls="carta" aria-label="Abrir carta">
          <svg viewBox="0 0 120 110" role="img" aria-hidden="true">
            <path d="M60 100
                     C 20 70, 10 55, 10 40
                     C 10 25, 22 15, 36 15
                     C 48 15, 55 22, 60 30
                     C 65 22, 72 15, 84 15
                     C 98 15, 110 25, 110 40
                     C 110 55, 100 70, 60 100 Z"
                  fill="#16a34a" stroke="#e11d48" stroke-width="6" />
          </svg>
          <span class="label">Abrir<br/>carta</span>
        </button>
      </div>
    </section>

    <!-- CARTA -->
    <section id="carta" class="carta" aria-label="Carta de aniversário" hidden>
      <div class="letter">
        <h2>Para Jéssica ❤️</h2>

        <div class="controls-line">
          <button id="speed" class="mini" type="button">⏩ Acelerar texto</button>
          <button id="restart" class="mini" type="button">↺ Rever do início</button>
        </div>

        <!-- Texto com efeito máquina (seu texto polido, mantendo sua voz) -->
        <p class="tline" data-typer="Hoje é o seu aniversário, mas o presente somos nós. Desde o primeiro dia em que te vi, eu me apaixonei por você."></p>
        <p class="tline" data-typer="Quero que saiba: eu estarei sempre ao seu lado. Estamos há 16 anos juntos, 14 de casados, e depois de 10 anos Deus nos presenteou com a Alê (Alexandra), que traz alegrias e nos ensina a sermos melhores a cada dia."></p>
        <p class="tline" data-typer="Que este dia seja tão especial quanto você é em nossas vidas. Obrigado por ser essa mulher maravilhosa, por todo carinho e pelas suas orações."></p>
        <p class="tline" data-typer="Que o Senhor ouça cada uma delas — você é ‘amiga de Deus’ — e que todos os seus sonhos, projetos e desejos se realizem."></p>
        <p class="tline" data-typer="Te amo todos os dias!!!"></p>

        <div class="meta" id="meta">
          <span class="pill">Para: <strong>Jéssica</strong></span>
          <span class="pill">De: <strong>Felipe Palhares</strong></span>
        </div>

        <!-- Assinatura -->
        <div class="signature" id="signature" style="display:none">
          <svg class="sig" viewBox="0 0 380 60" width="100%" height="50" aria-hidden="true">
            <path d="M10 35 C40 10, 70 10, 100 35 S160 60, 190 35 240 10, 280 35 330 60, 370 35" />
          </svg>
          <div style="font-weight:800;color:#0a7a3b;margin-top:4px;">Felipe Palhares</div>
        </div>

        <div class="hint" style="margin-top:6px">No celular, a música começa após um toque.</div>
      </div>

      <div>
        <figure class="hero" id="zoom"><img src="assets/imagem_cartao.png" alt="Imagem do cartão" /></figure>

        <!-- PLAYER -->
        <aside class="player" aria-label="Música do cartão">
          <div class="diskrow">
            <div id="cd" class="cd" aria-hidden="true"></div>
            <div class="title">Todo dia, até morrer</div>
          </div>

          <canvas id="viz" class="viz" aria-hidden="true"></canvas>

          <div class="controls">
            <button id="btnPlay" class="play">▶ Tocar</button>
            <div class="bar" id="seek" aria-label="Barra de progresso"><i id="fill"></i></div>
            <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
            <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume">
          </div>

          <button id="replay" class="replay">↺ Ouvir novamente</button>

          <audio id="audio" preload="auto">
            <source src="assets/musica.mp3" type="audio/mpeg">
          </audio>
        </aside>
      </div>
    </section>

    <footer>Feito com amor ❤️</footer>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="close" id="closeLb" aria-label="Fechar imagem">Fechar ✕</button>
    <img src="assets/imagem_cartao.png" alt="Imagem em tela cheia">
  </div>

<script>
  const $ = sel => document.querySelector(sel);

  /* principais */
  const capa   = $('#capa'), carta = $('#carta'), abrir = $('#abrir'), flap = $('#flap'),
        fallback = $('#fallback'), ctawrap = $('#ctawrap'), mood = $('#mood');

  /* typewriter */
  let cps = 9; // mais calmo para leitura
  const speedBtn = $('#speed'), restartBtn = $('#restart');
  const lines = Array.from(document.querySelectorAll('.tline'));
  const meta = $('#meta'); const signature = $('#signature');

  function pause(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function typeLine(el, text){
    el.style.opacity = 1; el.textContent = "";
    let i=0, delay = 1000/cps;
    return new Promise(resolve=>{
      const iv = setInterval(()=>{
        el.textContent += text[i++] || "";
        if(i>text.length){ clearInterval(iv); resolve(); }
      }, delay);
    });
  }
  async function runTypewriter(){
    meta.style.opacity = 0; signature.style.display='none';
    for(const el of lines){ await typeLine(el, el.getAttribute('data-typer')); await pause(220); }
    meta.style.transition="opacity .6s"; meta.style.opacity=1;
    signature.style.display='block';
    fireworks();
  }
  function resetTypewriter(){
    lines.forEach(p=>{ p.textContent=''; p.style.opacity=0; });
    runTypewriter();
  }
  speedBtn.addEventListener('click', ()=>{
    cps = cps>=18 ? 9 : cps+3; // 9 -> 12 -> 15 -> 18 -> volta
    speedBtn.textContent = (cps>9? '⏸ Desacelerar' : '⏩ Acelerar texto');
  });
  restartBtn.addEventListener('click', resetTypewriter);

  /* player */
  const audio  = $('#audio'), btn = $('#btnPlay'), cur = $('#cur'), dur = $('#dur'),
        seek   = $('#seek'), fill = $('#fill'), vol = $('#vol'), cd = $('#cd'),
        hero   = $('#zoom'), replayBtn = $('#replay');

  // tempo aproximado do refrão (edite se quiser)
  const CHORUS_TIME = 60; // s
  const CHORUS_LEN  = 14;

  audio.addEventListener('loadedmetadata', ()=>{ dur.textContent = fmt(audio.duration); });
  audio.addEventListener('timeupdate', ()=>{
    cur.textContent = fmt(audio.currentTime);
    fill.style.width = ((audio.currentTime/(audio.duration||1))*100) + "%";
    const t = audio.currentTime;
    hero.classList.toggle('glow', t >= CHORUS_TIME && t <= CHORUS_TIME + CHORUS_LEN);
  });
  btn.addEventListener('click', async ()=>{
    try{
      if(audio.paused){ await audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); replayBtn.style.display='none'; }
      else{ audio.pause(); btn.textContent='▶ Tocar'; cd.classList.remove('spin'); hero.classList.remove('glow'); }
    }catch(e){}
  });
  audio.addEventListener('ended', ()=>{
    btn.textContent='▶ Tocar'; cd.classList.remove('spin'); hero.classList.remove('glow');
    replayBtn.style.display='inline-flex';
  });
  replayBtn.addEventListener('click', async ()=>{
    replayBtn.style.display='none';
    audio.currentTime = 0; resetTypewriter();
    try{ await audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); }catch(e){}
    confettiOnce();
  });

  function setFromClientX(x){
    const rect = seek.getBoundingClientRect();
    const ratio = Math.min(1, Math.max(0, (x-rect.left)/rect.width));
    audio.currentTime = ratio * (audio.duration||0);
  }
  seek.addEventListener('click', e => setFromClientX(e.clientX));
  let dragging=false;
  seek.addEventListener('pointerdown', e=>{ dragging=true; setFromClientX(e.clientX); seek.setPointerCapture(e.pointerId); });
  seek.addEventListener('pointermove', e=>{ if(dragging) setFromClientX(e.clientX); });
  seek.addEventListener('pointerup',   e=>{ dragging=false; });
  vol.addEventListener('input', ()=>{ audio.volume = +vol.value; });

  function fmt(secs){ if(!isFinite(secs)) return "0:00"; const m=Math.floor(secs/60), s=Math.floor(secs%60); return m+":"+(s<10?"0":"")+s; }

  /* equalizador NOVO — 32 barras, log, contraste, picos + batimento + luzes */
  const vizCanvas = $('#viz'); const ctx = vizCanvas.getContext('2d', { alpha:true });
  let audioCtx, analyser, dataArray, peaks=[], smoothed=[];
  const BARS = 32;

  function ensureAudioGraph(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    analyser.minDecibels = -90;
    analyser.maxDecibels = -10;
    analyser.smoothingTimeConstant = 0.65;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    peaks = Array(BARS).fill(0);
    smoothed = Array(BARS).fill(0);
    src.connect(analyser); analyser.connect(audioCtx.destination);
  }
  btn.addEventListener('click', ensureAudioGraph, {once:true});
  abrir.addEventListener('click', ensureAudioGraph, {once:true});
  fallback.addEventListener('click', ensureAudioGraph, {once:true});

  function binFor(i){
    const frac = i/(BARS-1);
    const exp = Math.pow(frac, 1.8);
    return Math.min(dataArray.length-1, Math.floor(exp * (dataArray.length-1)));
  }

  function drawViz(){
    requestAnimationFrame(drawViz);
    if(!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    const w = vizCanvas.width = vizCanvas.clientWidth, h = vizCanvas.height = vizCanvas.clientHeight;
    const bw = w / BARS - 2;
    ctx.clearRect(0,0,w,h);

    // energia média (usada no batimento e nas luzes)
    let energy = 0;
    for(let i=2;i<18;i++){ energy += dataArray[i]; }
    energy /= (16*255);
    const beat = 1 + Math.min(.12, energy*.35); // 1..1.12
    ctawrap.style.setProperty('--beat', beat.toFixed(3));
    mood.style.setProperty('--hue', (energy*120|0)+'deg');

    for(let i=0;i<BARS;i++){
      const idx = binFor(i);
      const v = dataArray[idx] / 255;
      const vBoost = Math.pow(v, 1.2);
      const bh = Math.max(2, (h-8) * vBoost);
      smoothed[i] = smoothed[i]*0.6 + bh*0.4;
      peaks[i] = Math.max(peaks[i]*0.98, smoothed[i]);

      const x = i*(bw+2), y = h - smoothed[i] - 4, r = 4;
      const hue = 130 + i*(220/BARS);

      ctx.fillStyle = `hsla(${hue}, 85%, ${40+v*35}%, .9)`;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+bw-r, y);
      ctx.quadraticCurveTo(x+bw, y, x+bw, y+r);
      ctx.lineTo(x+bw, y+smoothed[i]-r);
      ctx.quadraticCurveTo(x+bw, y+smoothed[i], x+bw-r, y+smoothed[i]);
      ctx.lineTo(x+r, y+smoothed[i]);
      ctx.quadraticCurveTo(x, y+smoothed[i], x, y+smoothed[i]-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath(); ctx.fill();

      const capY = h - peaks[i] - 6;
      ctx.fillStyle = `hsla(${hue}, 95%, 92%, .95)`;
      ctx.fillRect(x, capY, bw, 3);
    }
  }
  drawViz();

  /* corações + brilhinhos + pétalas contínuos */
  function heartBurst(qty=10){
    for(let i=0;i<qty;i++){
      const h=document.createElement('div');
      h.className='heart';
      h.textContent=['💚','💖','💘','❤️'][i%4];
      h.style.left=(Math.random()*100)+'vw';
      h.style.setProperty('--x',(Math.random()*140-70)+'vw');
      h.style.animationDelay=(Math.random()*1.2)+'s';
      document.body.appendChild(h);
      setTimeout(()=>h.remove(),6500);
    }
  }
  function sparklesBurst(qty=12){
    for(let i=0;i<qty;i++){
      const s=document.createElement('div'); s.className='sparkle';
      s.style.left=(Math.random()*100)+'vw'; s.style.top=(Math.random()*40+10)+'vh';
      s.style.setProperty('--h', (Math.random()*120-60)+'deg');
      document.body.appendChild(s); setTimeout(()=>s.remove(),2200);
    }
  }
  function petals(qty=2){
    for(let i=0;i<qty;i++){
      const p=document.createElement('div'); p.className='petal'; p.textContent='🌹';
      p.style.left=(Math.random()*100)+'vw';
      p.style.setProperty('--px', (Math.random()*20-10)+'vw');
      p.style.animationDuration=(7+Math.random()*3)+'s';
      document.body.appendChild(p); setTimeout(()=>p.remove(),10000);
    }
  }
  setInterval(()=>heartBurst(3), 2800);
  setInterval(()=>sparklesBurst(3), 2200);
  setInterval(()=>petals(1), 1800);

  /* fogos/confete e abrir carta */
  function fireworks(){
    const colors=['#34d399','#22c55e','#86efac','#a7f3d0','#6ee7b7','#f9a8d4','#93c5fd'];
    for(let i=0;i<4;i++){
      const cx = Math.random()*80+10, cy = Math.random()*40+10;
      for(let p=0;p<24;p++){
        const dot = document.createElement('div');
        dot.style.position='fixed'; dot.style.width='6px'; dot.style.height='6px'; dot.style.borderRadius='50%';
        dot.style.left = cx+'vw'; dot.style.top = cy+'vh';
        dot.style.background = colors[(i+p)%colors.length];
        const ang = (p/24)*Math.PI*2, dist = Math.random()*12+8;
        const dx = Math.cos(ang)*dist, dy = Math.sin(ang)*dist;
        const style = document.createElement('style'); const name = `fw${i}_${p}`;
        style.textContent = `@keyframes ${name}{to{transform:translate(${dx}vw,${dy}vh);opacity:0}}`; document.head.appendChild(style);
        dot.style.animation = `${name} 900ms ease-out forwards`; document.body.appendChild(dot);
        setTimeout(()=>{dot.remove();style.remove();},1000);
      }
    }
  }
  function confettiOnce(){
    const colors=['🎉','✨','💚','💗','💙','💛','🧡'];
    for(let i=0;i<26;i++){
      const c=document.createElement('div'); c.textContent=colors[i%colors.length];
      c.style.position='fixed'; c.style.left='50%'; c.style.top='50%';
      c.style.transform='translate(-50%,-50%)'; c.style.fontSize=(Math.random()*14+14)+'px';
      const name=`conf${Date.now()}_${i}`, dx=(Math.random()*2-1)*45, dy=(Math.random()*2-1)*35, rot=(Math.random()*360)+'deg';
      const style=document.createElement('style'); style.textContent=`@keyframes ${name}{to{transform:translate(${dx}vw,${dy}vh) rotate(${rot});opacity:0}}`;
      document.head.appendChild(style); c.style.animation=`${name} 900ms ease-out forwards`;
      document.body.appendChild(c); setTimeout(()=>{c.remove();style.remove();},950);
    }
  }
  function abrirCarta(){
    flap.style.transform='rotateX(155deg)';
    setTimeout(()=>{
      capa.style.display='none'; carta.hidden=false; carta.style.display='grid';
      confettiOnce(); resetTypewriter();
      try{ audio.play(); btn.textContent='⏸ Pausar'; cd.classList.add('spin'); }catch(e){}
    }, 650);
  }
  abrir.addEventListener('click', abrirCarta);
  fallback.addEventListener('click', abrirCarta);

  /* lightbox */
  const zoom = $('#zoom'), lightbox = $('#lightbox'), closeLb  = $('#closeLb');
  zoom.addEventListener('click', ()=>{ lightbox.classList.add('show'); });
  closeLb.addEventListener('click', ()=>{ lightbox.classList.remove('show'); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lightbox.classList.remove('show'); });
  lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox) lightbox.classList.remove('show'); });
</script>

<noscript>
  <style>.capa{display:none}.carta{display:block}</style>
  <div style="max-width:700px;margin:20px auto;background:#fff;padding:16px;border-radius:10px;color:#000">
    Ative o JavaScript para ver a animação da carta e ouvir a música.
  </div>
</noscript>
</body>
</html>
